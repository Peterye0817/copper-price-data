# 工作流名称
name: Sync File from Gitee

# 授权工作流写入仓库内容的权限
permissions:
  contents: write

# 工作流触发条件
on:
  schedule:
    - cron: '0 13 * * *'  # 每天北京时间 21:00 运行 (13+8=21)
  workflow_dispatch:      # 允许手动运行

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出 GitHub 仓库
      - name: Checkout GitHub Repo
        uses: actions/checkout@v4

      # 2. 克隆 Gitee 仓库 (使用 Token 鉴权避免 403)
      # 这里使用了你的用户名 peter817 和刚才配置的 Secret
      - name: Clone Gitee Repo
        run: |
          git clone https://peter817:${{ secrets.GITEE_TOKEN }}@gitee.com/peter817/copper_record.git gitee-temp
        
      # 3. 从 Gitee 复制所需文件
      - name: Copy file from Gitee
        run: |
          # 确保文件存在再复制
          if [ -f "gitee-temp/copper_forex_daily.csv" ]; then
            cp gitee-temp/copper_forex_daily.csv ./
            echo "文件复制成功"
          else
            echo "错误: Gitee 仓库中未找到目标文件"
            exit 1
          fi

      # 4. 提交并推送到 GitHub
      - name: Commit and Push to GitHub
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add copper_forex_daily.csv
          
          # 检查是否有变动
          if git diff --staged --quiet; then
            echo "文件内容没有变化，跳过提交。"
          else
            echo "检测到变动，正在提交并推送..."
            git commit -m "chore: 自动同步 Gitee 数据文件 (From peter817/copper_record)"
            git push
          fi
